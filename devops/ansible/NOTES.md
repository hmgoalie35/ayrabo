## TODO

#### General:
* Add loadbalancing role
* Break tasks into reusable roles (nodejs), installing virtualenv, npm packages, etc.
* Can have the namecheap dns manager handle accessing the site via domain name, ip address, www.<domain-name> (www is a subdomain that is auto routed). Or can have nginx server_name listen on all 3. I'd do both. Make sure to test
* When site load increases and need to add load balancer, might be a good idea to only allow load balancer to connect to app servers. Use firewall on app servers to only allow connections from load balancer.

#### Deployment:
* ~~Run dist upgrade.~~
* ~~Create new directory for each deployment and venv in directory~~
* ~~Make pip cache packages, specify cache to live in directory or project files. We want fast venv builds~~
* ~~Have generic folder where all directories for each deployment live~~
* ~~Gunicorn point to symlink which points to desired deployment. Deploy directory being tags won't work for qa staging environments~~
* bit.ly/db-mg
* Setup accounts with as limited privileges as possible
* Git archive if not using push to deploy
* Build wheel of project?
* media files need to be stored outside of project dir (new project dir created each deployment)
* ~~`.env` file.~~
* Backup db before deployments
* gunicorn forwarded allow ips, make sure django knows https
* lets encrypt
* supervisor for postgres, nginx
* email, ssl
* see TODOs in settings.py
* media folder needs to be stored outside project dir for prod, for testing it can be stored in project dir.
* clean up `dist/`. Only files needed should be in there...
* fix up error pages
* Need to have proxy strip X-Forwarded-Proto header and then set it myself so nobody can spoof the header
* Speed up virtualenv, npm installs. Correctly organize dev, testing, prod dependencies for npm and pip
    * checksums of package.json and requirements.txt, if didn't change copy over node_modules and venv?
* On single server setup, when gunicorn restarts at end of deployment, you get 502 bad gateway. But maintenance mode and multiple app servers should mitigate this. Looking into sending SIGHUP or how to hot swap gunicorn binaries might be a good additive measure.
* Limit file upload sizes in nginx conf/django settings
* reload nginx config, update supervisor so have 0 downtime
    * will gracefully kill itself, however the current gunicorn setup (executable living in non global location will make this difficult. Need to hot swap binaries)

### Usage
* A few preconditions must be met on the remote hosts before running the playbooks
    * python 2 is installed.
    * A user named `ess` must exist.
    * ssh keys must be set up for `ess`

### NOTES
* Don't need `become_user: root` because the default is `root`
* Use `{{ ansible_managed }}` in templates to tell user don't touch the file, it's auto generated by ansible.
    * https://docs.ansible.com/ansible/intro_configuration.html#ansible-managed.
* https://docs.ansible.com/ansible/playbooks_variables.html#magic-variables-and-how-to-access-information-about-other-hosts
* secret_key can't have `=` sign. in settings.py, `.split('=')` breaks

#### Nginx
* When deploying to multiple servers, take one nginx out of the load balancer, or maybe shut down that server?
    * https://www.nginx.com/resources/wiki/start/topics/tutorials/commandline/#stopping-or-restarting-nginx
* Caching: https://www.nginx.com/resources/admin-guide/content-caching/
* Actual ssl certificate, not snakeoil...
    * `sudo mkdir /etc/nginx/ssl && sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt`
* Postgres & Django
    * charset/client_encoding: utf8
    * timezone: utc
    * max connections: need to decide
    * default_transaction_isolation: 'read committed'
